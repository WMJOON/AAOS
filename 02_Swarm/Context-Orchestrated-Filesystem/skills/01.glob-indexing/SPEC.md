# COF.Glob-Indexing.skill
Meta Spec (v0.2)

---

## 0. Purpose

본 문서는 COF(Context-Orchestrated Filesystem)에서 특정 디렉토리를 기준으로
가장 가까운 `/[n].index/`를 찾고, 그 범위 내 구조를 스캔하여
`/[n].index/` 하위에 **인덱싱 산출물(index artifacts)**을 생성/갱신하는 스킬
`cof-glob-indexing`의 스펙을 정의한다.

이 스킬의 목적은 다음을 만족하는 것이다.

1. 에이전트가 "현재 위치에서 유효한 컨텍스트 경계"를 빠르게 식별한다.
2. 디렉토리 패턴 `/[n].[role]/`을 기반으로 포인터 타입(역할)을 추론한다.
3. 주요 거점(Anchor)을 `/[n].index/` 중심으로 기록하여, 후속 에이전트가 재사용한다.
4. 역할 판단 근거를 `[{role: description}, ...]` 형태로 남긴다.

---

## 1. Scope

- 대상: COF 규칙을 따르는 디렉토리 트리
- 산출물 위치: **반드시** 선택된 `/[n].index/` 하위
- 스캔 대상: 선택된 인덱스의 "노드 경계(node boundary)" 내에서만 수행

---

## 2. Definitions

### 2.1 Node & Index Directory

- **Index Directory**: 이름이 `/[n].index/` 패턴을 만족하는 디렉토리
  - 예: `00.index/`, `10.index/`
- **Node Root**: 선택된 Index Directory의 **부모 디렉토리**
  - 예: `.../some-node/00.index/`라면 Node Root는 `.../some-node/`

### 2.2 Standard Role Token Set (Fixed)

본 스킬에서 `/[n].[role]/`의 `role` 토큰은 아래 **표준셋으로 고정**한다.

```
index
reference
working
ticket
runtime
history
```

> **표준셋 외 토큰 처리**: role directory로 해석하지 않으나, 발견 시 `ROLE_EVIDENCE.md`에 `unknown_directories` 항목으로 기록한다. 이는 향후 표준셋 확장 검토 또는 명명 오류 식별에 활용된다.

### 2.3 Nearest Index Resolution

입력 디렉토리 `target_dir`에 대해, "가장 가까운 인덱스"는 다음 절차로 결정한다.

1. `target_dir`에서 시작하여 상위로 올라가며,
2. 각 후보 디렉토리 `d`에 대해, 그 **자식** 중 `/[n].index/` 패턴을 만족하는 디렉토리가 존재하는지 검사한다.
3. 최초로 발견된 `/[n].index/`를 Nearest Index로 선택한다.

**Tie-breaker 규칙**: 동일 레벨에 여러 `/[n].index/`가 존재할 경우, **숫자 `n`이 가장 작은 것**을 선택한다. 숫자가 동일하면 사전순(lexicographic order)으로 첫 번째를 선택한다.

> 의미: "내가 지금 있는 위치가 속한 가장 가까운 COF 노드"를 찾는다.

### 2.4 Role Directory

- **Role Directory**: Node Root 바로 아래의 디렉토리 중, 이름이 `/[n].[role]/` 패턴을 만족하며 `role`이 표준셋에 포함되는 디렉토리
  - 예: `01.reference/`, `02.working/`, `03.ticket/`, `04.runtime/`, `99.history/`
- `n`(숫자 인덱스)는 ordering-only이며 의미를 가지지 않는다.
- `role`은 시스템이 해석하는 포인터 타입 토큰이며, 본 스킬에서는 **표준셋으로 고정**한다.

### 2.5 Anchor (Major Foothold)

본 스킬에서 **Anchor**는 기본적으로 다음을 의미한다.

- Node Root의 `/[n].index/` (primary anchor)
- Node Root 내부(하위 트리)에서 발견되는 "다른 `/[n].index/`"들의 위치 (secondary anchors)

---

## 3. Inputs

### 3.1 필수 입력

| 파라미터 | 타입 | 설명 |
|---------|------|------|
| `target_dir` | `string` | 인덱스를 생성/갱신하고 싶은 기준 디렉토리 (절대 경로) |

### 3.2 선택 입력

| 파라미터 | 타입 | 기본값 | 설명 |
|---------|------|--------|------|
| `max_depth` | `integer` | `10` | Node Root 기준 하위 탐색 최대 깊이 |
| `include_hidden` | `boolean` | `false` | 숨김 폴더(`.` prefix) 포함 여부 |
| `follow_symlinks` | `boolean` | `false` | 심볼릭 링크 추적 여부 |

---

## 4. Outputs (Index Artifacts)

선택된 `/[n].index/` 아래에 다음 산출물을 생성/갱신한다.

### 4.1 `NODE_INDEX.md` (Human-first)

목적: 후속 에이전트/인간이 빠르게 맥락 경계를 파악하도록 돕는다.

최소 포함 요소:
- Resolved Node Root 경로
- 발견된 Role Directory 목록
- 발견된 Anchor 목록(secondary anchors 포함)
- 스캔 시각/파라미터 요약

**템플릿 예시**:
```markdown
# Node Index
> Auto-generated by cof-glob-indexing

## Meta
- **Node Root**: `./project-alpha/`
- **Scanned At**: 2025-05-15T10:30:00Z
- **Parameters**: max_depth=10, include_hidden=false

## Role Directories
| Role | Path | Status |
|------|------|--------|
| index | `00.index/` | ✓ |
| reference | `01.reference/` | ✓ |
| working | `02.working/` | ✓ |

## Anchors
- **Primary**: `./project-alpha/00.index/`
- **Secondary**:
  - `./project-alpha/02.working/sub-module/00.index/`
```

### 4.2 `ROLE_EVIDENCE.md` (Agent-first)

목적: 역할/거점 판단의 근거를 구조화하여 남긴다.

최소 포함 요소:
- `[{role: description}, ...]` 형태의 목록(복붙 가능)
- 각 항목에 대한 근거(관찰된 경로/패턴)

**템플릿 예시**:
```markdown
# Role Evidence
> Auto-generated by cof-glob-indexing

## Detected Roles
```json
[
  {
    "role": "index",
    "path": "00.index/",
    "confidence": "certain",
    "evidence": "matches /[n].index/ pattern, standard role token"
  },
  {
    "role": "reference",
    "path": "01.reference/",
    "confidence": "certain",
    "evidence": "matches /[n].[role]/ pattern, standard role token"
  }
]
```

## Unknown Directories
> `/[n].[token]/` 패턴이지만 표준 role이 아닌 디렉토리

```json
[
  {
    "token": "archive",
    "path": "05.archive/",
    "note": "non-standard token, consider renaming to 99.history/"
  }
]
```
```

---

## 5. Core Workflow

### Step 1) Resolve Nearest Index

- 입력 `target_dir`에서 Nearest Index를 결정한다.
- Nearest Index가 없으면 스캔을 중단한다.
  - (선택) 상위 정책에 따라 "인덱스 생성 요청"을 반환할 수 있다.

### Step 2) Identify Node Root and Role Directories

- Node Root를 결정한다(Nearest Index의 부모).
- Node Root 직하위에서 `/[n].[role]/` 디렉토리를 모두 수집한다.
- 수집 결과 중 `role` 토큰이 표준셋에 포함되는 항목만 Role Directory로 해석한다.
- 표준셋 외 토큰은 "unknown role directory"로 분류하고 evidence에만 남긴다.

### Step 3) Discover Anchors (Secondary Indexes)

- Node Root 하위에서 `/[n].index/`를 탐색하여 secondary anchors로 수집한다.
- secondary anchors는 "거점 후보"로 기록하되,
  실제 접근/참조 정책은 RULE/Policy 계층에 의해 제한된다.

### Step 4) Emit Evidence

- 수집한 Role Directory 및 Anchors에 대해
  에이전트가 판단 가능한 근거를 `[{role: description}, ...]` 형태로 기록한다.
- 이때 `description`은 다음을 포함해야 한다.
  - 관찰된 경로(상대/절대 중 택1)
  - 역할 추론 근거(디렉토리명 패턴, 표준 role 토큰, 주변 구조)
  - "확실/추정" 등 신뢰 수준(간단 표기)

### Step 5) Write Index Artifacts

- 산출물은 반드시 선택된 `/[n].index/` 아래에 쓴다.
- 기존 산출물이 있으면 append가 아니라 "갱신"을 기본으로 한다.
  - (선택) 변경 이력은 `99.history/` 또는 상위 정책에 위임한다.

---

## 6. Error Handling

### 6.1 Nearest Index 미발견

| 조건 | 동작 |
|------|------|
| 루트(`/`)까지 탐색해도 `/[n].index/` 없음 | 스캔 중단, `INDEX_NOT_FOUND` 에러 반환 |
| 상위 정책에서 bootstrap 허용 시 | `INDEX_NOT_FOUND` + `bootstrap_suggested: true` 반환 |

### 6.2 파일시스템 에러

| 에러 유형 | 동작 |
|----------|------|
| 권한 거부 (Permission Denied) | 해당 경로 skip, `warnings[]`에 기록 후 계속 진행 |
| Symlink cycle 감지 | 해당 경로 skip, `warnings[]`에 기록 후 계속 진행 |
| 디렉토리 읽기 실패 | 해당 경로 skip, `warnings[]`에 기록 후 계속 진행 |

### 6.3 산출물 쓰기 실패

| 에러 유형 | 동작 |
|----------|------|
| Index Directory 쓰기 권한 없음 | 전체 작업 실패, `WRITE_PERMISSION_DENIED` 에러 반환 |
| 디스크 공간 부족 | 전체 작업 실패, `DISK_FULL` 에러 반환 |

### 6.4 반환 구조

```json
{
  "status": "success" | "partial" | "error",
  "error_code": null | "INDEX_NOT_FOUND" | "WRITE_PERMISSION_DENIED" | "DISK_FULL",
  "warnings": [
    {"path": "...", "reason": "permission_denied"},
    {"path": "...", "reason": "symlink_cycle"}
  ],
  "artifacts": {
    "node_index": "path/to/NODE_INDEX.md",
    "role_evidence": "path/to/ROLE_EVIDENCE.md"
  }
}
```

---

## 7. Hard Constraints

1. 숫자 인덱스(`n`)에 의미를 부여해서는 안 된다.
2. `/[n].index/`를 발견하지 못한 상태에서 루트 무제한 스캔을 수행해서는 안 된다.
3. Glob/패턴 매칭 결과는 Read Scope 후보를 제공할 뿐, 수정/삭제 권한을 의미해서는 안 된다.
4. `99.history/` 등 정책/아카이브 영역은 기본적으로 Read-only Context로 취급해야 한다.
5. Role Directory로 해석 가능한 `role` 토큰은 표준셋(`index/reference/working/ticket/runtime/history`)으로 고정한다.

---

## 8. Non-goals

- 실행 코드 생성
- 정책 강제(권한 판단/위반 처리)
- 전역 인덱스(워크스페이스 전체) 생성

---

## 9. References

본 스킬이 참조하는 문서들. 경로는 **이 스킬이 위치한 Node Root 기준 상대 경로**로 표기한다.

| 문서 | 경로 | 설명 |
|------|------|------|
| Glob Patterns | `[skills]/00.pointerical-tooling/[reference]/glob-patterns.md` | glob 패턴 문법 정의 |
| Rule Normative | `[skills]/00.pointerical-tooling/[reference]/rule-normative-interpretation.md` | 규칙 해석 지침 |
| COF Rule Genome | `[root]/cof-environment-set.md` | COF 전체 규칙 정의 |

> **경로 표기법**: `[role]`은 해당 role을 가진 디렉토리의 실제 이름(예: `00.index/`, `01.reference/`)으로 치환한다. `[root]`는 해당 COF 노드의 Node Root를 의미한다.

---

## Appendix A. Changelog

| 버전 | 날짜 | 변경 사항 |
|------|------|----------|
| v0.1 | - | 초안 작성 |
| v0.2 | - | 섹션 번호 오류 수정, tie-breaker 규칙 추가, 입력 기본값 명시, 산출물 템플릿 추가, 에러 핸들링 섹션 추가, 표준셋 외 토큰 처리 명확화 |
